(function e(t,i,a){function s(n,o){if(!i[n]){if(!t[n]){var l=typeof require=="function"&&require;if(!o&&l)return l(n,!0);if(r)return r(n,!0);var h=new Error("Cannot find module '"+n+"'");throw h.code="MODULE_NOT_FOUND",h}var d=i[n]={exports:{}};t[n][0].call(d.exports,function(e){var i=t[n][1][e];return s(i?i:e)},d,d.exports,e,t,i,a)}return i[n].exports}var r=typeof require=="function"&&require;for(var n=0;n<a.length;n++)s(a[n]);return s})({"./src/Advanced_MultiPassSponzaDemo.ts":[function(e,t,i){var a=e("awayjs-core/lib/data/BlendMode");var s=e("awayjs-core/lib/data/Geometry");var r=e("awayjs-core/lib/events/Event");var n=e("awayjs-core/lib/events/AssetEvent");var o=e("awayjs-core/lib/events/ProgressEvent");var l=e("awayjs-core/lib/events/LoaderEvent");var h=e("awayjs-core/lib/geom/UVTransform");var d=e("awayjs-core/lib/geom/Vector3D");var u=e("awayjs-core/lib/library/AssetLibrary");var c=e("awayjs-core/lib/library/AssetLoaderContext");var _=e("awayjs-core/lib/net/URLLoader");var f=e("awayjs-core/lib/net/URLLoaderDataFormat");var g=e("awayjs-core/lib/net/URLRequest");var p=e("awayjs-core/lib/parsers/ParserUtils");var m=e("awayjs-core/lib/textures/ImageTexture");var w=e("awayjs-core/lib/textures/SpecularBitmapTexture");var y=e("awayjs-core/lib/ui/Keyboard");var v=e("awayjs-core/lib/utils/RequestAnimationFrame");var b=e("awayjs-display/lib/containers/Loader");var j=e("awayjs-display/lib/containers/View");var M=e("awayjs-display/lib/controllers/FirstPersonController");var T=e("awayjs-display/lib/entities/Mesh");var x=e("awayjs-display/lib/entities/Skybox");var S=e("awayjs-display/lib/entities/DirectionalLight");var D=e("awayjs-display/lib/entities/PointLight");var A=e("awayjs-display/lib/materials/lightpickers/StaticLightPicker");var L=e("awayjs-display/lib/prefabs/PrimitivePlanePrefab");var E=e("awayjs-display/lib/utils/Cast");var k=e("awayjs-renderergl/lib/tools/commands/Merge");var P=e("awayjs-renderergl/lib/DefaultRenderer");var C=e("awayjs-methodmaterials/lib/MethodMaterial");var R=e("awayjs-methodmaterials/lib/MethodMaterialMode");var O=e("awayjs-methodmaterials/lib/pool/MethodRendererPool");var U=e("awayjs-methodmaterials/lib/methods/ShadowSoftMethod");var F=e("awayjs-methodmaterials/lib/methods/EffectFogMethod");var B=e("awayjs-parsers/lib/AWDParser");var z=function(){function e(){this._assetsRoot="assets/";this._materialNameStrings=Array("arch","Material__298","bricks","ceiling","chain","column_a","column_b","column_c","fabric_g","fabric_c","fabric_f","details","fabric_d","fabric_a","fabric_e","flagpole","floor","16___Default","Material__25","roof","leaf","vase","vase_hanging","Material__57","vase_round");this._diffuseTextureStrings=Array("arch_diff.jpg","background.jpg","bricks_a_diff.jpg","ceiling_a_diff.jpg","chain_texture.png","column_a_diff.jpg","column_b_diff.jpg","column_c_diff.jpg","curtain_blue_diff.jpg","curtain_diff.jpg","curtain_green_diff.jpg","details_diff.jpg","fabric_blue_diff.jpg","fabric_diff.jpg","fabric_green_diff.jpg","flagpole_diff.jpg","floor_a_diff.jpg","gi_flag.jpg","lion.jpg","roof_diff.jpg","thorn_diff.png","vase_dif.jpg","vase_hanging.jpg","vase_plant.png","vase_round.jpg");this._normalTextureStrings=Array("arch_ddn.jpg","background_ddn.jpg","bricks_a_ddn.jpg",null,"chain_texture_ddn.jpg","column_a_ddn.jpg","column_b_ddn.jpg","column_c_ddn.jpg",null,null,null,null,null,null,null,null,null,null,"lion2_ddn.jpg",null,"thorn_ddn.jpg","vase_ddn.jpg",null,null,"vase_round_ddn.jpg");this._specularTextureStrings=Array("arch_spec.jpg",null,"bricks_a_spec.jpg","ceiling_a_spec.jpg",null,"column_a_spec.jpg","column_b_spec.jpg","column_c_spec.jpg","curtain_spec.jpg","curtain_spec.jpg","curtain_spec.jpg","details_spec.jpg","fabric_spec.jpg","fabric_spec.jpg","fabric_spec.jpg","flagpole_spec.jpg","floor_a_spec.jpg",null,null,null,"thorn_spec.jpg",null,null,"vase_plant_spec.jpg","vase_round_spec.jpg");this._numTexStrings=Array(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);this._meshReference=new Array(25);this._flameData=Array(new I(new d(-625,165,219),16755268),new I(new d(485,165,219),16755268),new I(new d(-625,165,-148),16755268),new I(new d(485,165,-148),16755268));this._textureDictionary=new Object;this._multiMaterialDictionary=new Object;this._singleMaterialDictionary=new Object;this.vaseMeshes=new Array;this.poleMeshes=new Array;this.colMeshes=new Array;this._singlePassMaterial=false;this._multiPassMaterial=true;this._cascadeLevels=3;this._shadowOptions="PCF";this._depthMapSize=2048;this._lightDirection=Math.PI/2;this._lightElevation=Math.PI/18;this._lights=new Array;this._numTextures=0;this._currentTexture=0;this._n=0;this._meshes=new Array;this._move=false;this._drag=.5;this._walkIncrement=10;this._strafeIncrement=10;this._walkSpeed=0;this._strafeSpeed=0;this._walkAcceleration=0;this._strafeAcceleration=0;this._time=0;this.init()}e.prototype.init=function(){this.initEngine();this.initLights();this.initListeners();this._n=0;this._loadingTextureStrings=this._diffuseTextureStrings;this.countNumTextures();this._n=0;this._loadingTextureStrings=this._diffuseTextureStrings;this.load(this._loadingTextureStrings[this._n])};e.prototype.initEngine=function(){this._view=new j(new P(O));this._view.camera.y=150;this._view.camera.z=0;this._cameraController=new M(this._view.camera,90,0,-80,80)};e.prototype.initLights=function(){this._lights=new Array;this._directionalLight=new S(-1,-15,1);this._directionalLight.color=15654365;this._directionalLight.ambient=.35;this._directionalLight.ambientColor=8421520;this._view.scene.addChild(this._directionalLight);this._lights.push(this._directionalLight);this.updateDirection();var e;var t=this._flameData.length;for(var i=0;i<t;i++){e=this._flameData[i];var a=e.light=new D;a.radius=200;a.fallOff=600;a.color=e.color;a.y=10;this._lights.push(a)}this._lightPicker=new A(this._lights);this._baseShadowMethod=new U(this._directionalLight,10,5);this._fogMethod=new F(0,4e3,9474279)};e.prototype.initObjects=function(){this._view.scene.addChild(new x(this._skyMap));this._flameGeometry=new L(40,80,1,1,false,true);var e;var t=this._flameData.length;for(var i=0;i<t;i++){e=this._flameData[i];var a=e.mesh=this._flameGeometry.getNewObject();a.material=this._flameMaterial;a.transform.position=e.position;a.subMeshes[0].uvTransform=new h;a.subMeshes[0].uvTransform.scaleU=1/16;this._view.scene.addChild(a);a.addChild(e.light)}};e.prototype.initListeners=function(){var e=this;window.onresize=function(t){return e.onResize(t)};document.onmousedown=function(t){return e.onMouseDown(t)};document.onmouseup=function(t){return e.onMouseUp(t)};document.onmousemove=function(t){return e.onMouseMove(t)};document.onkeydown=function(t){return e.onKeyDown(t)};document.onkeyup=function(t){return e.onKeyUp(t)};this.onResize();this.parseAWDDelegate=function(t){return e.parseAWD(t)};this.parseBitmapDelegate=function(t){return e.parseBitmap(t)};this.loadProgressDelegate=function(t){return e.loadProgress(t)};this.onBitmapCompleteDelegate=function(t){return e.onBitmapComplete(t)};this.onAssetCompleteDelegate=function(t){return e.onAssetComplete(t)};this.onResourceCompleteDelegate=function(t){return e.onResourceComplete(t)};this._timer=new v(this.onEnterFrame,this);this._timer.start()};e.prototype.updateDirection=function(){this._directionalLight.direction=new d(Math.sin(this._lightElevation)*Math.cos(this._lightDirection),-Math.cos(this._lightElevation),Math.sin(this._lightElevation)*Math.sin(this._lightDirection))};e.prototype.countNumTextures=function(){this._numTextures++;while(this._n++<this._loadingTextureStrings.length-1)if(this._loadingTextureStrings[this._n])break;if(this._n<this._loadingTextureStrings.length){this.countNumTextures()}else if(this._loadingTextureStrings==this._diffuseTextureStrings){this._n=0;this._loadingTextureStrings=this._normalTextureStrings;this.countNumTextures()}else if(this._loadingTextureStrings==this._normalTextureStrings){this._n=0;this._loadingTextureStrings=this._specularTextureStrings;this.countNumTextures()}};e.prototype.load=function(e){var t=new _;switch(e.substring(e.length-3)){case"AWD":case"awd":t.dataFormat=f.ARRAY_BUFFER;this._loadingText="Loading Model";t.addEventListener(r.COMPLETE,this.parseAWDDelegate);break;case"png":case"jpg":t.dataFormat=f.BLOB;this._currentTexture++;this._loadingText="Loading Textures";t.addEventListener(r.COMPLETE,this.parseBitmapDelegate);e="sponza/"+e;break}t.addEventListener(o.PROGRESS,this.loadProgressDelegate);var i=new g(this._assetsRoot+e);t.load(i)};e.prototype.loadProgress=function(e){var t=Math.floor(e["bytesLoaded"]/e["bytesTotal"]*100);if(t!=100){console.log(this._loadingText+"\n"+(this._loadingText=="Loading Model"?Math.floor(e["bytesLoaded"]/1024<<0)+"kb | "+Math.floor(e["bytesTotal"]/1024<<0)+"kb":this._currentTexture+" | "+this._numTextures))}};e.prototype.parseBitmap=function(e){var t=e.target;var i=p.blobToImage(t.data);i.onload=this.onBitmapCompleteDelegate;t.removeEventListener(r.COMPLETE,this.parseBitmapDelegate);t.removeEventListener(o.PROGRESS,this.loadProgressDelegate);t=null};e.prototype.onBitmapComplete=function(e){var t=e.target;t.onload=null;if(!this._textureDictionary[this._loadingTextureStrings[this._n]])this._textureDictionary[this._loadingTextureStrings[this._n]]=this._loadingTextureStrings==this._specularTextureStrings?new w(E.bitmapData(t)):new m(t);while(this._n++<this._loadingTextureStrings.length-1)if(this._loadingTextureStrings[this._n])break;if(this._n<this._loadingTextureStrings.length){this.load(this._loadingTextureStrings[this._n])}else if(this._loadingTextureStrings==this._diffuseTextureStrings){this._n=0;this._loadingTextureStrings=this._normalTextureStrings;this.load(this._loadingTextureStrings[this._n])}else if(this._loadingTextureStrings==this._normalTextureStrings){this._n=0;this._loadingTextureStrings=this._specularTextureStrings;this.load(this._loadingTextureStrings[this._n])}else{this.load("sponza/sponza.awd")}};e.prototype.parseAWD=function(e){console.log("Parsing Data");var t=e.target;var i=new b(false);i.addEventListener(n.ASSET_COMPLETE,this.onAssetCompleteDelegate);i.addEventListener(l.RESOURCE_COMPLETE,this.onResourceCompleteDelegate);i.loadData(t.data,new c(false),null,new B);t.removeEventListener(o.PROGRESS,this.loadProgressDelegate);t.removeEventListener(r.COMPLETE,this.parseAWDDelegate);t=null};e.prototype.onAssetComplete=function(e){if(e.asset.isAsset(T)){this._meshes.push(e.asset)}};e.prototype.onResourceComplete=function(e){var t=this;var i=new k(false,false,true);var a=e.target;a.removeEventListener(n.ASSET_COMPLETE,this.onAssetCompleteDelegate);a.removeEventListener(l.RESOURCE_COMPLETE,this.onResourceCompleteDelegate);var r;var o;var h=this._meshes.length;for(var d=0;d<h;d++){r=this._meshes[d];if(r.name=="sponza_04"||r.name=="sponza_379")continue;var _=Number(r.name.substring(7));o=r.material.name;if(o=="column_c"&&(_<22||_>33))continue;var f=_-125;if(o=="column_b"){if(f>=0&&f<132&&f%11<10){this.colMeshes.push(r);continue}else{this.colMeshes.push(r);var p=new k;var m=new T(new s);p.applyToMeshes(m,this.colMeshes);r=m;this.colMeshes=new Array}}var w=_-334;if(o=="vase_hanging"&&w%9<5){if(w>=0&&w<370&&w%9<4){this.vaseMeshes.push(r);continue}else{this.vaseMeshes.push(r);var y=new k;var v=new T(new s);y.applyToMeshes(v,this.vaseMeshes);r=v;this.vaseMeshes=new Array}}var b=_-290;if(o=="flagpole"){if(b>=0&&b<320&&b%3<2){this.poleMeshes.push(r);continue}else if(b>=0){this.poleMeshes.push(r);var j=new k;var M=new T(new s);j.applyToMeshes(M,this.poleMeshes);r=M;this.poleMeshes=new Array}}if(o=="flagpole"&&(_==260||_==261||_==263||_==265||_==268||_==269||_==271||_==273))continue;var x=this._materialNameStrings.indexOf(o);if(x==-1||x>=this._materialNameStrings.length)continue;this._numTexStrings[x]++;var S=this._diffuseTextureStrings[x];var D;var A;var L=this._multiMaterialDictionary[o];if(!L){L=new C(this._textureDictionary[S]);L.mode=R.MULTI_PASS;L.name=o;L.lightPicker=this._lightPicker;L.shadowMethod=this._baseShadowMethod;L.addEffectMethod(this._fogMethod);L.repeat=true;L.mipmap=true;L.specular=2;if(S.substring(S.length-3)=="png")L.alphaThreshold=.5;D=this._normalTextureStrings[x];if(D)L.normalMap=this._textureDictionary[D];A=this._specularTextureStrings[x];if(A)L.specularMap=this._textureDictionary[A];this._multiMaterialDictionary[o]=L}r.material=L;this._view.scene.addChild(r);this._meshReference[x]=r}var E=0;while(E<this._numTexStrings.length){console.log(this._diffuseTextureStrings[E],this._numTexStrings[E]);E++}u.addEventListener(l.RESOURCE_COMPLETE,function(e){return t.onExtraResourceComplete(e)});var P=new c;P.dependencyBaseUrl="assets/skybox/";u.load(new g("assets/skybox/hourglass_texture.cube"),P);u.load(new g("assets/fire.png"))};e.prototype.onExtraResourceComplete=function(e){switch(e.url){case"assets/skybox/hourglass_texture.cube":this._skyMap=e.assets[0];break;case"assets/fire.png":this._flameMaterial=new C(e.assets[0]);this._flameMaterial.blendMode=a.ADD;this._flameMaterial.animateUVs=true;break}if(this._skyMap&&this._flameMaterial)this.initObjects()};e.prototype.onEnterFrame=function(e){if(this._walkSpeed||this._walkAcceleration){this._walkSpeed=(this._walkSpeed+this._walkAcceleration)*this._drag;if(Math.abs(this._walkSpeed)<.01)this._walkSpeed=0;this._cameraController.incrementWalk(this._walkSpeed)}if(this._strafeSpeed||this._strafeAcceleration){this._strafeSpeed=(this._strafeSpeed+this._strafeAcceleration)*this._drag;if(Math.abs(this._strafeSpeed)<.01)this._strafeSpeed=0;this._cameraController.incrementStrafe(this._strafeSpeed)}var t;var i=this._flameData.length;for(var a=0;a<i;a++){t=this._flameData[a];var s=t.light;if(!s)continue;s.fallOff=380+Math.random()*20;s.radius=200+Math.random()*30;s.diffuse=.9+Math.random()*.1;var r=t.mesh;if(!r)continue;var n=r.subMeshes[0];n.uvTransform.offsetU+=1/16;n.uvTransform.offsetU%=1;r.rotationY=Math.atan2(r.x-this._view.camera.x,r.z-this._view.camera.z)*180/Math.PI}this._view.render()};e.prototype.onKeyDown=function(e){switch(e.keyCode){case y.UP:case y.W:this._walkAcceleration=this._walkIncrement;break;case y.DOWN:case y.S:this._walkAcceleration=-this._walkIncrement;break;case y.LEFT:case y.A:this._strafeAcceleration=-this._strafeIncrement;break;case y.RIGHT:case y.D:this._strafeAcceleration=this._strafeIncrement;break;case y.F:break;case y.C:this._cameraController.fly=!this._cameraController.fly}};e.prototype.onKeyUp=function(e){switch(e.keyCode){case y.UP:case y.W:case y.DOWN:case y.S:this._walkAcceleration=0;break;case y.LEFT:case y.A:case y.RIGHT:case y.D:this._strafeAcceleration=0;break}};e.prototype.onMouseDown=function(e){this._lastPanAngle=this._cameraController.panAngle;this._lastTiltAngle=this._cameraController.tiltAngle;this._lastMouseX=e.clientX;this._lastMouseY=e.clientY;this._move=true};e.prototype.onMouseUp=function(e){this._move=false};e.prototype.onMouseMove=function(e){if(this._move){this._cameraController.panAngle=.3*(e.clientX-this._lastMouseX)+this._lastPanAngle;this._cameraController.tiltAngle=.3*(e.clientY-this._lastMouseY)+this._lastTiltAngle}};e.prototype.onResize=function(e){if(e===void 0){e=null}this._view.y=0;this._view.x=0;this._view.width=window.innerWidth;this._view.height=window.innerHeight};return e}();var I=function(){function e(e,t){this.position=e;this.color=t}return e}();window.onload=function(){new z}},{"awayjs-core/lib/data/BlendMode":undefined,"awayjs-core/lib/data/Geometry":undefined,"awayjs-core/lib/events/AssetEvent":undefined,"awayjs-core/lib/events/Event":undefined,"awayjs-core/lib/events/LoaderEvent":undefined,"awayjs-core/lib/events/ProgressEvent":undefined,"awayjs-core/lib/geom/UVTransform":undefined,"awayjs-core/lib/geom/Vector3D":undefined,"awayjs-core/lib/library/AssetLibrary":undefined,"awayjs-core/lib/library/AssetLoaderContext":undefined,"awayjs-core/lib/net/URLLoader":undefined,"awayjs-core/lib/net/URLLoaderDataFormat":undefined,"awayjs-core/lib/net/URLRequest":undefined,"awayjs-core/lib/parsers/ParserUtils":undefined,"awayjs-core/lib/textures/ImageTexture":undefined,"awayjs-core/lib/textures/SpecularBitmapTexture":undefined,"awayjs-core/lib/ui/Keyboard":undefined,"awayjs-core/lib/utils/RequestAnimationFrame":undefined,"awayjs-display/lib/containers/Loader":undefined,"awayjs-display/lib/containers/View":undefined,"awayjs-display/lib/controllers/FirstPersonController":undefined,"awayjs-display/lib/entities/DirectionalLight":undefined,"awayjs-display/lib/entities/Mesh":undefined,"awayjs-display/lib/entities/PointLight":undefined,"awayjs-display/lib/entities/Skybox":undefined,"awayjs-display/lib/materials/lightpickers/StaticLightPicker":undefined,"awayjs-display/lib/prefabs/PrimitivePlanePrefab":undefined,"awayjs-display/lib/utils/Cast":undefined,"awayjs-methodmaterials/lib/MethodMaterial":undefined,"awayjs-methodmaterials/lib/MethodMaterialMode":undefined,"awayjs-methodmaterials/lib/methods/EffectFogMethod":undefined,"awayjs-methodmaterials/lib/methods/ShadowSoftMethod":undefined,"awayjs-methodmaterials/lib/pool/MethodRendererPool":undefined,"awayjs-parsers/lib/AWDParser":undefined,"awayjs-renderergl/lib/DefaultRenderer":undefined,"awayjs-renderergl/lib/tools/commands/Merge":undefined}]},{},["./src/Advanced_MultiPassSponzaDemo.ts"]);

//# sourceMappingURL=Advanced_MultiPassSponzaDemo.js.map